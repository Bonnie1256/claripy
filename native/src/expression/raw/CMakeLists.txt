# Add current directory's source files
target_sources("${SHARED_LIB_NAME}" PRIVATE
	symbolic.cpp
	concrete.cpp
	base.cpp
)

# Add type sources
add_subdirectory(type)

# Define all Ops that should have their subclasses autogenerated
# We set this list to empty and expect the ops subdirectory to edit it
set(OPS "")

# Add op sources
# Additionally, OPS should be edited
add_subdirectory(op)

# Used to configure op.hpp
set(OP_INCLUDES "")
set(OP_SHARED_PTRS "")

# Configure each autogen'd file
foreach(OP ${OPS})
	set(EXPRESSION_OP "${OP}")
	string(TOLOWER "${OP}" EXPRESSION_OP_LOWER)

	# Configure header
	set(IN_HEADER "${CMAKE_CURRENT_SOURCE_DIR}/op_template.hpp.in")
	set(OUT_HEADER_BASENAME "${EXPRESSION_OP_LOWER}.hpp")
	set(OUT_HEADER "${CMAKE_CURRENT_SOURCE_DIR}/autogen/${OUT_HEADER_BASENAME}")
	configure_file("${IN_HEADER}" "${OUT_HEADER}" @ONLY)
	# Add the header to op_includes
	# Cmake lists disallow semicolons so we use '|' and replace it later
	list(APPEND OP_INCLUDES "#include \"op/${OUT_HEADER_BASENAME}\"")
	list(APPEND OP_SHARED_PTRS "using ${OP} = std::shared_ptr<Raw::Op::${OP}>|")

	# Configure source
	set(IN_SOURCE "${CMAKE_CURRENT_SOURCE_DIR}/op_template.cpp.in")
	set(OUT_SOURCE "${CMAKE_CURRENT_SOURCE_DIR}/autogen/${EXPRESSION_OP_LOWER}.cpp")
	configure_file("${IN_SOURCE}" "${OUT_SOURCE}" @ONLY)
	# Add out the souce to the shared library
	target_sources("${SHARED_LIB_NAME}" PRIVATE "${OUT_SOURCE}")

endforeach()

# Configure op.hpp
string(REPLACE ";" "\n" OP_INCLUDES "${OP_INCLUDES}")
string(REPLACE ";" "\n" OP_SHARED_PTRS "${OP_SHARED_PTRS}")
string(REPLACE "|" ";" OP_SHARED_PTRS "${OP_SHARED_PTRS}")
configure_file("op.hpp.in" "${CMAKE_CURRENT_SOURCE_DIR}/op.hpp" @ONLY)
